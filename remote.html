<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAKO REMOTE S3</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --theme: #ff00ff; --bg: #050505; --cyan: #00e5ff; --yellow: #ffff00; }
        body { background: var(--bg); color: #fff; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; overflow: hidden; }
        
        /* Bouton retour */
        .back-home { position: absolute; top: 20px; left: 20px; color: var(--cyan); text-decoration: none; font-size: 0.9rem; border-bottom: 1px solid var(--cyan); }

        .remote-container { border: 2px solid var(--theme); background: rgba(0,0,0,0.9); width: 92%; max-width: 450px; border-radius: 30px; box-shadow: 0 0 30px var(--theme); padding: 25px; display: flex; flex-direction: column; align-items: center; transition: 0.3s; z-index: 10; }
        
        .virtual-screen {
            width: 100%; height: 140px; background: #000; border: 3px solid var(--theme); border-radius: 15px;
            margin-bottom: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 10px; text-align: center; box-shadow: inset 0 0 15px rgba(255,255,255,0.05);
        }

        #screen-text { font-family: 'Courier New', monospace; font-size: 1.2rem; color: var(--theme); text-transform: uppercase; }
        #captured-pass { color: #ff0000; font-weight: bold; font-size: 1.8rem; margin-top: 10px; text-shadow: 0 0 10px rgba(255,0,0,0.5); }

        #status { margin-bottom: 20px; padding: 8px 20px; border-radius: 50px; border: 1px solid var(--theme); color: var(--theme); cursor: pointer; font-size: 0.9rem; }
        #status.connected { background: var(--theme); color: #000; font-weight: bold; }

        .d-pad { display: grid; grid-template-columns: repeat(3, 80px); grid-template-rows: repeat(3, 80px); gap: 12px; }
        .ctrl-btn { width: 80px; height: 80px; background: #111; border: 2px solid var(--theme); color: var(--theme); border-radius: 20px; font-size: 1.8rem; cursor: pointer; transition: 0.1s; display: flex; align-items: center; justify-content: center; }
        .ctrl-btn:active { transform: scale(0.9); background: var(--theme); color: #000; }
        .btn-ok { background: #fff; color: #000; border: none; font-size: 1.4rem; font-weight: bold; }

        /* Style de la Pop-up Automatique (identique index) */
        .modal-hako {
            display: none; position: fixed; z-index: 9999;
            left: 0; top: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);
        }
        .modal-content {
            background: #111; border: 2px solid var(--yellow);
            margin: 15% auto; padding: 30px; width: 85%; max-width: 400px;
            text-align: center; border-radius: 20px; box-shadow: 0 0 30px var(--yellow);
        }
        .btn-close-modal {
            background: var(--yellow); color: #000; border: none;
            padding: 10px 30px; border-radius: 50px; font-weight: bold;
            margin-top: 20px; cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="popup-update" class="modal-hako">
        <div class="modal-content">
            <h2 style="color: var(--yellow);">MODE REMOTE ACTIVÉ</h2>
            <p style="color: #fff;">Dernière mise à jour système :</p>
            <h3 style="color: var(--cyan);">06 Janvier 2026</h3>
            <p style="font-size: 0.8rem; color: #888;">Connectez votre Lilygo en USB pour piloter l'interface.</p>
            <button class="btn-close-modal" onclick="closeHakoPopup()">DÉMARRER</button>
        </div>
    </div>

    <a href="index.html" class="back-home">← Retour à l'accueil</a>

    <div class="remote-container" id="main-box">
        <h2 style="margin-top:0; letter-spacing: 3px; color: var(--theme);">HAKO S3</h2>

        <div class="virtual-screen" id="v-screen">
            <div id="screen-text">NON CONNECTÉ</div>
            <div id="captured-pass"></div>
        </div>

        <div id="status" onclick="initSerial()"><i class="fas fa-plug"></i> CONNECTER USB</div>

        <div class="d-pad">
            <button class="ctrl-btn" style="grid-column: 2;" onclick="send('U')"><i class="fas fa-chevron-up"></i></button>
            <button class="ctrl-btn" style="grid-column: 1; grid-row: 2;" onclick="send('L')"><i class="fas fa-chevron-left"></i></button>
            <button class="ctrl-btn btn-ok" style="grid-column: 2; grid-row: 2;" onclick="send('S')">OK</button>
            <button class="ctrl-btn" style="grid-column: 3; grid-row: 2;" onclick="send('R')"><i class="fas fa-chevron-right"></i></button>
            <button class="ctrl-btn" style="grid-column: 2; grid-row: 3;" onclick="send('D')"><i class="fas fa-chevron-down"></i></button>
        </div>
    </div>

    <script>
        // --- GESTION DE LA POP-UP ---
        window.onload = function() {
            document.getElementById('popup-update').style.display = 'block';
        };

        function closeHakoPopup() {
            document.getElementById('popup-update').style.display = 'none';
        }

        let port, writer;

        async function initSerial() {
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 115200 });
                
                const statusBtn = document.getElementById('status');
                statusBtn.classList.add('connected');
                statusBtn.innerHTML = "<i class='fas fa-link'></i> LILYGO CONNECTÉ";
                
                writer = port.writable.getWriter();
                readLoop();
            } catch (err) { alert("Erreur: " + err); }
        }

        async function readLoop() {
            const decoder = new TextDecoder();
            while (port.readable) {
                const reader = port.readable.getReader();
                try {
                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
                        const data = decoder.decode(value);
                        
                        // --- GESTION DU TEXTE ---
                        if (data.includes("TEXT:")) {
                            let msg = data.split("TEXT:")[1].split("\n")[0].trim();
                            document.getElementById('screen-text').innerText = msg;
                            if (!msg.includes("CAPTURE")) document.getElementById('captured-pass').innerText = "";
                        }

                        // --- GESTION DE LA COULEUR ---
                        if (data.includes("COLOR:")) {
                            let hex = "#" + data.split("COLOR:")[1].trim().substring(0,6);
                            document.documentElement.style.setProperty('--theme', hex);
                        }

                        // --- GESTION DU MOT DE PASSE ---
                        if (data.includes("PASS:")) {
                            let pass = data.split("PASS:")[1].trim();
                            document.getElementById('screen-text').innerText = "MDP RÉCUPÉRÉ :";
                            document.getElementById('captured-pass').innerText = pass;
                        }
                    }
                } catch (err) { console.error(err); } finally { reader.releaseLock(); }
            }
        }

        async function send(cmd) {
            if (writer) {
                const encoder = new TextEncoder();
                await writer.write(encoder.encode(cmd));
            }
        }
    </script>
</body>
</html>